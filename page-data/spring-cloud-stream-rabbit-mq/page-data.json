{"componentChunkName":"component---src-templates-blog-post-js","path":"/spring-cloud-stream-rabbit-mq/","result":{"data":{"site":{"siteMetadata":{"title":"지은이의 개발 Blog","author":"Jieun Hong"}},"markdownRemark":{"id":"f72ebe32-ccfc-5ee8-a8c1-6e40763d8761","html":"<p>RabbitMQ의 메세지를 받기 위한 AMQP 프로토콜을 구현한 프레임워크인 Spring Cloud Stream을 이용하여 Consumer를 만들기 위함.</p>\n<h2 id=\"spring-cloud-stream\"><a href=\"#spring-cloud-stream\" aria-hidden class=\"anchor\"><svg aria-hidden=\"true\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Spring Cloud Stream</h2>\n<h3 id=\"1-spring-cloud-stream\"><a href=\"#1-spring-cloud-stream\" aria-hidden class=\"anchor\"><svg aria-hidden=\"true\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>1. Spring Cloud Stream</h3>\n<p>Spring Cloud 진영에서 메세지 통신을 위해 구축된 프레임워크.</p>\n<p>이벤트 기반(event-driven) 마이크로 서비스를 구축하기 위해 탄생되었음.</p>\n<p>Spring Cloud Stream은 <a href=\"https://github.com/spring-cloud/spring-cloud-stream-binder-kafka\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Kafka</a> 및 <a href=\"https://github.com/spring-cloud/spring-cloud-stream-binder-rabbit\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Rabbit MQ</a> 용 바인더 구현을 제공한다.</p>\n<p>다만 세세한 MQ 설정은 Spring Cloud Stream이 아닌 개별 AMPQ을 구현하는 것이 좋다. (세부 설정 힘듬)</p>\n<p>\n  <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/76b2e79933af208b089ef1bf050cb9b1/67a5d/0.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n  \n  <span\n    class=\"gatsby-resp-image-wrapper\"\n    style=\"position: relative; display: block;  max-width: 373px; margin-left: auto; margin-right: auto;\"\n  >\n    <span\n      class=\"gatsby-resp-image-background-image\"\n      style=\"padding-bottom: 83.1081081081081%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAARCAIAAABSJhvpAAAACXBIWXMAAAsTAAALEwEAmpwYAAAB2klEQVR42oWTR28iQRCF5//DgQMcQAhztcRP4MCBnHNYgsk55+TBH13rMUas9knTqq6q1/W6ukYrl8uFQqFYLJZKpWq1WqvVKpUKxh8FtuI0DKIkQ4GorddrXddvt9t8PsdFuNls1uv1drtNmDyMigIhtqTdFDabjbZcLmVzOBzk+A+FVqvFKWy73S5nQcZJwm63k3yqaqvVSjbUl1N1hU8F/RvYhEg+nU4/lR/Js9kM45EjNDH+Q55Op6InEomkUqlYLJbJZFCbSCQmkwmhxWLxT7LRDC5GC47HIyuVL5eLyKZBL8gSy+VyyWSSsiJBpGYUwuFwMBjsdDqQxf9M9nq9DofDYrGgs9/v0/DBYGCz2ex2u9lsNplMPJ5x6J3Mt9/vs9ks7xEIBDwej8vl4pEIn89n1ncFp9PJEVRuNBr5fJ7322639yG5Xq/0mVS/3+92u61WK7MFjauyvikgh+JoIbPX68H6kS1K4HDnaDSKZhpLneFwGI/H6TyNCIVCFJQL/h2S0WhEDzmC9bFPVKBPDCwNN5w8B28GjeTxeHwfz8cZoCAeScJAm3gABjSZmefxFIgqyD6fj+dJp9Os0IzJ+9Vt48d4gv4bTyGRqdFxufNLoO2lX270BUoBpetgKO+LAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n    >\n      <img\n        class=\"gatsby-resp-image-image\"\n        style=\"width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px white;\"\n        alt=\"Untitled\"\n        title=\"\"\n        src=\"/static/76b2e79933af208b089ef1bf050cb9b1/67a5d/0.png\"\n        srcset=\"/static/76b2e79933af208b089ef1bf050cb9b1/12f09/0.png 148w,\n/static/76b2e79933af208b089ef1bf050cb9b1/e4a3f/0.png 295w,\n/static/76b2e79933af208b089ef1bf050cb9b1/67a5d/0.png 373w\"\n        sizes=\"(max-width: 373px) 100vw, 373px\"\n      />\n    </span>\n  </span>\n  \n  </a>\n    </p>\n<p>Spring Cloud Stream 애플리케이션은 미들웨어 중립적 코어로 구성된다.</p>\n<p>애플리케이션은 브로커에 의해 노출된 대상과 바인딩 을 설정하여 통신한다.</p>\n<p>바인딩을 설정하는 데 필요한 브로커별 세부 정보는 미들웨어별 바인더 구현에서 처리한다.</p>\n<p>Binder가 MQ 브로커를 의미하는데 Spring Cloud Stream은 다양한 MQ를 지원한다.</p>\n<ul>\n<li><a href=\"https://github.com/spring-cloud/spring-cloud-stream-binder-rabbit\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">RabbitMQ</a></li>\n<li><a href=\"https://github.com/spring-cloud/spring-cloud-stream-binder-kafka\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Apache Kafka</a></li>\n<li><a href=\"https://github.com/spring-cloud/spring-cloud-stream-binder-kafka/tree/master/spring-cloud-stream-binder-kafka-streams\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Kafka Streams</a></li>\n<li><a href=\"https://github.com/spring-cloud/spring-cloud-stream-binder-aws-kinesis\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Amazon Kinesis</a></li>\n<li><a href=\"https://github.com/spring-cloud/spring-cloud-gcp/tree/master/spring-cloud-gcp-pubsub-stream-binder\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Google PubSub (partner maintained)</a></li>\n<li><a href=\"https://github.com/SolaceProducts/spring-cloud-stream-binder-solace\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Solace PubSub+ (partner maintained)</a></li>\n<li><a href=\"https://github.com/Azure/azure-sdk-for-java/tree/main/sdk/spring/spring-cloud-azure-stream-binder-eventhubs\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Azure Event Hubs (partner maintained)</a></li>\n<li><a href=\"https://github.com/Azure/azure-sdk-for-java/tree/main/sdk/spring/spring-cloud-azure-stream-binder-servicebus\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Azure Service Bus (partner maintained)</a></li>\n<li><a href=\"https://github.com/idealo/spring-cloud-stream-binder-sqs\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">AWS SQS (partner maintained)</a></li>\n<li><a href=\"https://github.com/idealo/spring-cloud-stream-binder-sns\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">AWS SNS (partner maintained)</a></li>\n<li><a href=\"https://github.com/alibaba/spring-cloud-alibaba/wiki/RocketMQ-en\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Apache RocketMQ (partner maintained)</a></li>\n</ul>\n<h3 id=\"2-사용방법\"><a href=\"#2-%EC%82%AC%EC%9A%A9%EB%B0%A9%EB%B2%95\" aria-hidden class=\"anchor\"><svg aria-hidden=\"true\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>2. 사용방법</h3>\n<p>사용방법은 크게 2가지가 있다.</p>\n<ol>\n<li>Annotation Based Programming Model</li>\n<li>Funtional Programming Model</li>\n</ol>\n<p>이 중 1번째인 Annotation기반은 spring-cloud-stream 모듈과 spring-cloud-stream-reactive 모듈이 합쳐짐으로 인해 더 이상 사용하지 않고, functional을 권장하고 있다.</p>\n<p>따라서 이 문서에서는 1번 방법을 따로 서술하지 않습니다.</p>\n<h3 id=\"주목할만한-지원-중단\"><a href=\"#%EC%A3%BC%EB%AA%A9%ED%95%A0%EB%A7%8C%ED%95%9C-%EC%A7%80%EC%9B%90-%EC%A4%91%EB%8B%A8\" aria-hidden class=\"anchor\"><svg aria-hidden=\"true\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://docs.spring.io/spring-cloud-stream/docs/current/reference/html/spring-cloud-stream.html#spring-cloud-stream-preface-notable-deprecations\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">주목할만한 지원 중단</a></h3>\n<ul>\n<li>Annotation 기반 프로그래밍 모델. 기본적으로 @EnableBInding, @StreamListener 및 모든 관련 Annotation은 이제 Funtional 프로그래밍 모델을 위해 @deprecated 되어있습니다. 자세한 내용은 <a href=\"https://docs.spring.io/spring-cloud-stream/docs/current/reference/html/spring-cloud-stream.html#spring_cloud_function\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Spring Cloud Function 지원</a> 을 참조하세요.</li>\n<li><em>반응 모듈</em> ( spring-cloud-stream-reactive)은 중단되었으며 spring-cloud-function을 통한 기본 지원을 위해 더 이상 배포되지 않습니다. 이전 버전과의 호환성을 위해 여전히 spring-cloud-stream-reactive이전 버전에서 가져올 수 있습니다.</li>\n<li>spring-cloud-stream-test-support새 테스트 바인더를 위해 MessageCollector로 <em>지원 바인더 를 테스트합니다.</em> 자세한 내용은 <a href=\"https://docs.spring.io/spring-cloud-stream/docs/current/reference/html/spring-cloud-stream.html#_testing\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">테스트</a> 를 참조하세요.</li>\n<li><em>@StreamMessageConverter</em> - 더 이상 필요하지 않으므로 더 이상 사용되지 않습니다.</li>\n<li>헤더 참조 는 original-content-typev2.0에서 더 이상 사용되지 않는 후 제거되었습니다.</li>\n<li>속성 을 제공하는 경우 더 BinderAwareChannelResolver이상 사용되지 않습니다 . spring.cloud.stream.sendto.destination이것은 주로 함수 기반 프로그래밍 모델을 위한 것입니다. StreamListener의 경우 여전히 필요하므로 StreamListener 및 주석 기반 프로그래밍 모델을 더 이상 사용하지 않고 중단할 때까지 유지됩니다.</li>\n</ul>\n<p>크게 메세지를 보내는 Producer와 받는 Consumer 2개의 프로젝트가 필요합니다.</p>\n<hr>\n<h1 id=\"producer\"><a href=\"#producer\" aria-hidden class=\"anchor\"><svg aria-hidden=\"true\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><strong>Producer</strong></h1>\n<p><strong>build.gradle</strong></p>\n<div class=\"gatsby-highlight\" data-language=\"jsx\"><pre class=\"language-jsx\"><code class=\"language-jsx\">dependencies <span class=\"token punctuation\">{</span>\n    implementation <span class=\"token string\">'org.springframework.boot:spring-boot-starter'</span>\n    implementation <span class=\"token string\">'org.springframework.boot:spring-boot-starter-web'</span>\n    testImplementation <span class=\"token string\">'org.springframework.boot:spring-boot-starter-test'</span>\n\n    annotationProcessor <span class=\"token string\">'org.projectlombok:lombok'</span>\n    compileOnly <span class=\"token string\">'org.projectlombok:lombok'</span>\n\n    implementation <span class=\"token string\">'org.springframework.cloud:spring-cloud-starter-stream-rabbit:3.2.4'</span>\n    implementation <span class=\"token string\">'com.fasterxml.jackson.datatype:jackson-datatype-jsr310:2.13.3'</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>Rest API로 Producer를 실행시키기 위해 spring-boot-starter-web,</p>\n<p>Spring Cloud Stream RabbitMQ를 위해 spring-cloud-starter-stream-rabbit 이 필요하다.</p>\n<p><strong>application.yml</strong></p>\n<div class=\"gatsby-highlight\" data-language=\"nasm\"><pre class=\"language-nasm\"><code class=\"language-nasm\"><span class=\"token label function\">spring:</span>\n  <span class=\"token label function\">cloud:</span>\n    <span class=\"token label function\">function:</span>\n      <span class=\"token label function\">definition:</span> direct\n    <span class=\"token label function\">stream:</span>\n      <span class=\"token label function\">bindings:</span>\n        direct<span class=\"token operator\">-</span>out<span class=\"token operator\">-</span><span class=\"token number\">0</span>:\n          <span class=\"token label function\">binder:</span> rabbit\n          <span class=\"token label function\">destination:</span> test\n      <span class=\"token label function\">binders:</span>\n        <span class=\"token label function\">rabbit:</span>\n          <span class=\"token label function\">type:</span> rabbit\n          <span class=\"token label function\">environment:</span>\n            <span class=\"token label function\">spring:</span>\n              <span class=\"token label function\">rabbitmq:</span>\n                <span class=\"token label function\">host:</span> <span class=\"token number\">127.0</span>.<span class=\"token number\">0.1</span>\n                <span class=\"token label function\">port:</span> <span class=\"token number\">55001</span>\n                <span class=\"token label function\">username:</span> guest\n                <span class=\"token label function\">password:</span> guest\n\n  <span class=\"token label function\">rabbitmq:</span>\n    <span class=\"token label function\">host:</span> <span class=\"token number\">127.0</span>.<span class=\"token number\">0.1</span>\n    <span class=\"token label function\">port:</span> <span class=\"token number\">55001</span>\n    <span class=\"token label function\">username:</span> guest\n    <span class=\"token label function\">password:</span> guest\n<span class=\"token label function\">server:</span>\n  <span class=\"token label function\">port:</span> <span class=\"token number\">8080</span></code></pre></div>\n<p>Spring Cloud Stream의 바인딩 네이밍 규칙은  아래와 같다.</p>\n<p><strong>Producer인 경우  [bindingName]-out-[숫자 (0부터 시작) ]</strong></p>\n<p><strong>Consumer인 경우 [bindingName]-in-[숫자 (0부터 시작) ]</strong></p>\n<p>Spring Cloud Stream 에서는 함수를 Bean에 등록시켜주면 bindingName과 일치하는 빈을 찾아서 연결해준다.</p>\n<p>숫자의 경우 MultiBinder 지원을 위해 존재한다.</p>\n<p><em>카프카와 RabbitMQ를 동시에 쓸 경우, 아래와 같이 명명한다.</em></p>\n<p>direct-out-0 | direct-out-1</p>\n<p><strong>binder에는 사용할 Binder의 종류와 설정 정보를 명시해주면 된다.</strong></p>\n<p>현재 RabbitMQ를 바인더로 쓸 예정이기 때문에 관련 정보를 넣어두었다.</p>\n<p>참고로 <strong>destination</strong>은 RabbitMQ에서 <strong>exchange</strong>와 동일한 의미를 지닌다.</p>\n<p>실제로 코드를 실행시키면 RabbitMQ 대시보드에서 확인할 수 있다.</p>\n<p>\n  <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/49caca8eea4b0a9995ff7815e3fe582b/874d1/1.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n  \n  <span\n    class=\"gatsby-resp-image-wrapper\"\n    style=\"position: relative; display: block;  max-width: 590px; margin-left: auto; margin-right: auto;\"\n  >\n    <span\n      class=\"gatsby-resp-image-background-image\"\n      style=\"padding-bottom: 102.7027027027027%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAVCAIAAADJt1n/AAAACXBIWXMAAAsTAAALEwEAmpwYAAACqUlEQVR42nVU23LiMAzNz++P7Bsf0Zn2oVPoLB1KaLYJkABJyNWO7RgCzW1PbJbS6fQ8tBpZ0pGOFIzen/Xj331g9t6kjhxCi+Px+PHxwRgTQpxOp/P5fFBo27b/CqOTpI3slic9ixpJq9O5qWvk5HmO/KIosizzfZ8QguSu65BzNYy6aRPQMQ5HmpP9fi+lBBsMlBiNRr8U7u7uUChN06ZpwjCsqgr5Bmcsz7KBg9JKNYzMWpHDRiHOOfrHLPDDiScYeIJhxHH89vY2N83n52ewwYWuUP76t1No/6O5gYFoFD5IqVVBydvnWqH5AQZjHJIczwOhjuu+An49SPcNRqk4t6TGeELh2p6OQBqUh7//BkMrdOtCGoRB2vlUoW9IheonBT2aXj5g2Lb98PDgKZQl+pCYYj6fM0qtteeF0dK2zcUCilrWX8uyBnXn89VqhWAjCIKnp6fZbLYPw+EmKMXyhqtI4hUVTkorWYINL7gTqWaEgf0NbSNuMpmgGJ6ZAqV0s92SJHFytsxoiYLqqbgBaIfk3Xb7+Pg4Ho9JTlAVwiButV5nceQS7mb0WAquhNTXog20cGHGeby8vMCIogi00Hbtusk+XCTUigmnhNAB5PJ/MLT4l+TpnynEcF2XK/hBUOS5mRZWWkhxYdTf2Rfm3W53f3+/XC6xT7SNYfDsbTY0S9d5sU6JxLRKi6sonzPjE5lOpxBssVi8v7+bprnZbOAs8kwJVkhW/JiMVl9fX8Gm1jQMDAOzcEJcItycVQK9lLIc7q8UaGwQ8CAPQzJ4ILWvgPPQJVzPg9p2Suw4Y1gDIfiSkyQhCiC47Bkzo2fHcdA2ktHPIJgfsDx3iFhm7CA47k5X1/f/KRhKIge/DHrJWm2Q4FYSJpKCC84gN9gQpgMwtk7+B/vrlQdHWwcrAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n    >\n      <img\n        class=\"gatsby-resp-image-image\"\n        style=\"width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px white;\"\n        alt=\"Untitled\"\n        title=\"\"\n        src=\"/static/49caca8eea4b0a9995ff7815e3fe582b/fcda8/1.png\"\n        srcset=\"/static/49caca8eea4b0a9995ff7815e3fe582b/12f09/1.png 148w,\n/static/49caca8eea4b0a9995ff7815e3fe582b/e4a3f/1.png 295w,\n/static/49caca8eea4b0a9995ff7815e3fe582b/fcda8/1.png 590w,\n/static/49caca8eea4b0a9995ff7815e3fe582b/efc66/1.png 885w,\n/static/49caca8eea4b0a9995ff7815e3fe582b/c83ae/1.png 1180w,\n/static/49caca8eea4b0a9995ff7815e3fe582b/874d1/1.png 1310w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n      />\n    </span>\n  </span>\n  \n  </a>\n    </p>\n<p><strong>SampleMessage.java</strong></p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">@Data\n@NoArgsConstructor\n@AllArgsConstructor\n@Builder\npublic class SampleMessage implements Serializable {\n    private String message;\n}</code></pre></div>\n<p>간단한 문자열 변수가 담긴 객체를 생성한다.</p>\n<p><strong>ProducerConfig.java</strong></p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">@Configuration\n@Slf4j\npublic class ProducerConfig {\n\n    @Bean\n    public Sinks.Many&lt;Message&lt;SampleMessage&gt;&gt; many() {\n        return Sinks.many().unicast().onBackpressureBuffer();\n    }\n\n    @Bean\n    public Supplier&lt;Flux&lt;Message&lt;SampleMessage&gt;&gt;&gt; direct(Sinks.Many&lt;Message&lt;SampleMessage&gt;&gt; many) {\n        return () -&gt; many.asFlux()\n                .doOnNext(m -&gt; log.info(&quot;Manually sending message {}&quot;, m))\n                .doOnError(t -&gt; log.error(&quot;Error encountered&quot;, t));\n    }\n\n}</code></pre></div>\n<p>Producer 관련 설정을 정의한다.</p>\n<p><strong>아까 BindingName을 direct 라고 정의해줬기 때문에  Supplier함수명을 direct로 맞춰주었다.</strong></p>\n<p><strong>Bean Name 에 direct라고 명시해도 된다.</strong></p>\n<p><strong>MessageController.java</strong></p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token annotation punctuation\">@RestController</span>\n<span class=\"token annotation punctuation\">@Slf4j</span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">MessageController</span> <span class=\"token punctuation\">{</span>\n\n    <span class=\"token annotation punctuation\">@Autowired</span>\n    <span class=\"token keyword\">private</span> <span class=\"token class-name\">Sinks<span class=\"token punctuation\">.</span>Many</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Message</span><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">SampleMessage</span><span class=\"token punctuation\">></span><span class=\"token punctuation\">></span></span> many<span class=\"token punctuation\">;</span>\n\n    <span class=\"token annotation punctuation\">@GetMapping</span><span class=\"token punctuation\">(</span>value <span class=\"token operator\">=</span> <span class=\"token string\">\"/direct/{message}\"</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">public</span> <span class=\"token class-name\">Mono</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Void</span><span class=\"token punctuation\">></span></span> <span class=\"token function\">directMessage</span><span class=\"token punctuation\">(</span><span class=\"token annotation punctuation\">@PathVariable</span> <span class=\"token class-name\">String</span> message<span class=\"token punctuation\">)</span> <span class=\"token keyword\">throws</span> <span class=\"token class-name\">IOException</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">return</span> <span class=\"token class-name\">Mono</span><span class=\"token punctuation\">.</span><span class=\"token function\">just</span><span class=\"token punctuation\">(</span>message<span class=\"token punctuation\">)</span>\n                <span class=\"token punctuation\">.</span><span class=\"token function\">doOnNext</span><span class=\"token punctuation\">(</span>m <span class=\"token operator\">-></span> <span class=\"token punctuation\">{</span>\n                    <span class=\"token class-name\">SampleMessage</span> myMessage <span class=\"token operator\">=</span> <span class=\"token class-name\">SampleMessage</span><span class=\"token punctuation\">.</span><span class=\"token function\">builder</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">message</span><span class=\"token punctuation\">(</span>m<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">build</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                    many<span class=\"token punctuation\">.</span><span class=\"token function\">emitNext</span><span class=\"token punctuation\">(</span>\n                            <span class=\"token class-name\">MessageBuilder</span><span class=\"token punctuation\">.</span><span class=\"token function\">withPayload</span><span class=\"token punctuation\">(</span>myMessage<span class=\"token punctuation\">)</span>\n                                    <span class=\"token punctuation\">.</span><span class=\"token function\">setHeader</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">MessageHeaders</span><span class=\"token punctuation\">.</span>CONTENT_TYPE<span class=\"token punctuation\">,</span> <span class=\"token class-name\">MimeTypeUtils</span><span class=\"token punctuation\">.</span>APPLICATION_JSON<span class=\"token punctuation\">)</span>\n                                    <span class=\"token punctuation\">.</span><span class=\"token function\">build</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n                            <span class=\"token class-name\">Sinks<span class=\"token punctuation\">.</span>EmitFailureHandler</span><span class=\"token punctuation\">.</span>FAIL_FAST\n                    <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n                <span class=\"token punctuation\">.</span><span class=\"token function\">doOnNext</span><span class=\"token punctuation\">(</span>m <span class=\"token operator\">-></span> log<span class=\"token punctuation\">.</span><span class=\"token function\">info</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"send {}\"</span><span class=\"token punctuation\">,</span> m<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n                <span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>실제로  API가 호출되는 시점에 메세지를 보내는 로직이다.</p>\n<p>현업 프로젝트에서 Header에 데이터가 담길 수도 있을 것 같아 Message객체 안에 SampleMassage를 넣어서 보내주고 있다.</p>\n<p>이렇게 간단하게 끝이다.</p>\n<hr>\n<h1 id=\"consumer\"><a href=\"#consumer\" aria-hidden class=\"anchor\"><svg aria-hidden=\"true\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Consumer</h1>\n<p><strong>build.gradle</strong></p>\n<div class=\"gatsby-highlight\" data-language=\"jsx\"><pre class=\"language-jsx\"><code class=\"language-jsx\">dependencies <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// spring cloud stream</span>\n    implementation <span class=\"token string\">'org.springframework.cloud:spring-cloud-starter-stream-rabbit:3.2.4'</span>\n    <span class=\"token comment\">// RabbitMQ serialization</span>\n    implementation <span class=\"token string\">'com.fasterxml.jackson.datatype:jackson-datatype-jsr310:2.13.3'</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>Spring Batch가 구현되어있는 Repository에 이식할 예정이라 기존 gradle에 2가지만 추가했다.</p>\n<p>application.yml</p>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token key atrule\">spring</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">cloud</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">function</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">definition</span><span class=\"token punctuation\">:</span> direct\n    <span class=\"token key atrule\">stream</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">bindings</span><span class=\"token punctuation\">:</span>\n        <span class=\"token key atrule\">direct-in-0</span><span class=\"token punctuation\">:</span>\n          <span class=\"token key atrule\">binder</span><span class=\"token punctuation\">:</span> rabbit\n          <span class=\"token key atrule\">destination</span><span class=\"token punctuation\">:</span> test\n      <span class=\"token key atrule\">binders</span><span class=\"token punctuation\">:</span>\n        <span class=\"token key atrule\">rabbit</span><span class=\"token punctuation\">:</span>\n          <span class=\"token key atrule\">type</span><span class=\"token punctuation\">:</span> rabbit\n          <span class=\"token key atrule\">environment</span><span class=\"token punctuation\">:</span>\n            <span class=\"token key atrule\">spring</span><span class=\"token punctuation\">:</span>\n              <span class=\"token key atrule\">rabbitmq</span><span class=\"token punctuation\">:</span>\n                <span class=\"token key atrule\">host</span><span class=\"token punctuation\">:</span> 127.0.0.1\n                <span class=\"token key atrule\">port</span><span class=\"token punctuation\">:</span> <span class=\"token number\">55001</span>\n                <span class=\"token key atrule\">username</span><span class=\"token punctuation\">:</span> guest\n                <span class=\"token key atrule\">password</span><span class=\"token punctuation\">:</span> guest\n\n  <span class=\"token comment\"># RabbitMQ config</span>\n  <span class=\"token key atrule\">rabbitmq</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">host</span><span class=\"token punctuation\">:</span> 127.0.0.1\n    <span class=\"token key atrule\">port</span><span class=\"token punctuation\">:</span> <span class=\"token number\">55001</span>\n    <span class=\"token key atrule\">username</span><span class=\"token punctuation\">:</span> guest\n    <span class=\"token key atrule\">password</span><span class=\"token punctuation\">:</span> guest\n\n<span class=\"token key atrule\">server</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">port</span><span class=\"token punctuation\">:</span> <span class=\"token number\">8081</span></code></pre></div>\n<p>Producer 설정과 동일하다. 다만 BindingName 중간 in이 out으로 변환되었다.</p>\n<p><strong>SpringBatchExampleApplication.java</strong></p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token annotation punctuation\">@Slf4j</span>\n<span class=\"token annotation punctuation\">@SpringBootApplication</span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">SpringBatchExampleApplication</span> <span class=\"token punctuation\">{</span>\n\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">void</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> args<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token class-name\">SpringApplication</span><span class=\"token punctuation\">.</span><span class=\"token function\">run</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">SpringBatchExampleApplication</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">class</span><span class=\"token punctuation\">,</span> args<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token annotation punctuation\">@Autowired</span>\n    <span class=\"token keyword\">private</span> <span class=\"token class-name\">JobLauncher</span> jobLauncher<span class=\"token punctuation\">;</span>\n\n    <span class=\"token annotation punctuation\">@Autowired</span>\n    <span class=\"token keyword\">private</span> <span class=\"token class-name\">Job</span> extractionPersonNameJob<span class=\"token punctuation\">;</span>\n\n    <span class=\"token annotation punctuation\">@Bean</span>\n    <span class=\"token keyword\">public</span> <span class=\"token class-name\">Function</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Flux</span><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">SampleMessage</span><span class=\"token punctuation\">></span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">Mono</span><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Void</span><span class=\"token punctuation\">></span><span class=\"token punctuation\">></span></span> <span class=\"token function\">receive</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">return</span> sampleMessageFlux <span class=\"token operator\">-></span> sampleMessageFlux<span class=\"token punctuation\">.</span><span class=\"token function\">doOnNext</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>sampleMessage<span class=\"token punctuation\">)</span> <span class=\"token operator\">-></span> <span class=\"token punctuation\">{</span>\n                            log<span class=\"token punctuation\">.</span><span class=\"token function\">info</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"##### message for direct : {}\"</span><span class=\"token punctuation\">,</span> sampleMessage<span class=\"token punctuation\">.</span><span class=\"token function\">getMessage</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                            <span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span>\n                                jobLauncher<span class=\"token punctuation\">.</span><span class=\"token function\">run</span><span class=\"token punctuation\">(</span>extractionPersonNameJob<span class=\"token punctuation\">,</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">JobParametersBuilder</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n                                        <span class=\"token punctuation\">.</span><span class=\"token function\">addString</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"message\"</span><span class=\"token punctuation\">,</span> sampleMessage<span class=\"token punctuation\">.</span><span class=\"token function\">getMessage</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n                                        <span class=\"token punctuation\">.</span><span class=\"token function\">toJobParameters</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                            <span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">Exception</span> e<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                                log<span class=\"token punctuation\">.</span><span class=\"token function\">error</span><span class=\"token punctuation\">(</span>e<span class=\"token punctuation\">.</span><span class=\"token function\">getMessage</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                            <span class=\"token punctuation\">}</span>\n                        <span class=\"token punctuation\">}</span>\n                <span class=\"token punctuation\">)</span>\n                <span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>Producer와 똑같이 direct라는 바인딩명과 일치하는 함수를 실행시킨다.</p>\n<p>Spring Batch Job을 실행시키기 위해 jobLancher를 이용했다.</p>\n<p>반응형으로 구현하기 위해 Consumer&#x3C;Flux<?>>대신 스트림의 마지막 연산자로 Function<Flux<?>, Mono<Void>> 로 변경했다.</p>\n<p><strong>3. Error Handling</strong></p>\n<p>더 조사해야함 ..</p>\n<h2 id=\"관련-문서\"><a href=\"#%EA%B4%80%EB%A0%A8-%EB%AC%B8%EC%84%9C\" aria-hidden class=\"anchor\"><svg aria-hidden=\"true\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>관련 문서</h2>\n<ul>\n<li><a href=\"https://docs.spring.io/spring-cloud-stream/docs/current/reference/html/index.html\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">https://docs.spring.io/spring-cloud-stream/docs/current/reference/html/index.html</a> - Spring Cloud Stream 레퍼런스 Doc</li>\n<li><a href=\"https://spring.io/projects/spring-cloud-stream\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">https://spring.io/projects/spring-cloud-stream</a> - Spring Cloud Stream Doc</li>\n<li><a href=\"https://docs.microsoft.com/ko-kr/azure/developer/java/spring-framework/configure-spring-cloud-stream-binder-java-app-azure-event-hub\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">https://docs.microsoft.com/ko-kr/azure/developer/java/spring-framework/configure-spring-cloud-stream-binder-java-app-azure-event-hub</a></li>\n<li><a href=\"https://brunch.co.kr/@springboot/51\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">https://brunch.co.kr/@springboot/51</a></li>\n<li><a href=\"https://medium.com/@odysseymoon/spring-cloud-stream-with-rabbitmq-c273ed9a79b\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">https://medium.com/@odysseymoon/spring-cloud-stream-with-rabbitmq-c273ed9a79b</a></li>\n</ul>","timeToRead":7,"frontmatter":{"title":"Spring Cloud Stream + RabbitMQ 사용해보기","date":"August 18, 2022","spoiler":"","cta":"Spring"},"fields":{"slug":"/spring-cloud-stream-rabbit-mq/","langKey":"en"}}},"pageContext":{"slug":"/spring-cloud-stream-rabbit-mq/","previous":{"fields":{"slug":"/rabbit-mq/","langKey":"en","directoryName":"rabbit-mq"},"frontmatter":{"title":"RabbitMQ 짧은 정리"}},"next":{"fields":{"slug":"/spring-batch-jpa-paging-item-reader/","langKey":"en","directoryName":"spring-batch-jpa-paging-item-reader"},"frontmatter":{"title":"Spring JpaItemPagingReader row update시 reader 누락 문제"}},"translations":[],"translatedLinks":[]}},"staticQueryHashes":["336482444"]}